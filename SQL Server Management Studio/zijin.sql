exec sp_executesql N'INSERT INTO T_BAS_TEMPORARYTABLENAME (FTABLENAME, FUSERTOKEN, FUSERTRANSACTIONID) VALUES (@FTABLENAME, @FUSERTOKEN, @FUSERTRANSACTIONID)',N'@FTABLENAME varchar(30),@FUSERTOKEN varchar(36),@FUSERTRANSACTIONID varchar(1)',@FTABLENAME='TMP8CEE7BC9ABD311E68117EC8F87C',@FUSERTOKEN='1e0540e2-b5d9-4b7f-9b87-4710d0dcc36d',@FUSERTRANSACTIONID=' '


select @@trancount; SET FMTONLY ON select * from T_BAS_TEMPORARYTABLENAME SET FMTONLY OFF exec ..sp_tablecollations_100 N'.[T_BAS_TEMPORARYTABLENAME]'
insert bulk T_BAS_TEMPORARYTABLENAME ([FTABLENAME] VarChar(30) COLLATE Chinese_PRC_CI_AS, [FUSERTOKEN] VarChar(36) COLLATE Chinese_PRC_CI_AS, [FUSERTRANSACTIONID] VarChar(200) COLLATE Chinese_PRC_CI_AS) with (CHECK_CONSTRAINTS)



CREATE TABLE #TM_AR_ORGENDDATE (FSETTLEORGID INT not null DEFAULT 0, FENDDATE DATETIME null, FSysStartDate DATETIME null)


CREATE TABLE #TM_AR_DETAILRPT_SUM (FID INT NOT NULL DEFAULT 0, FFORMID NVARCHAR (80) NULL, FBILLNO NVARCHAR (80) NOT NULL DEFAULT ' ', FDATE DATETIME NULL, 
FBUSINESSRANK INT NULL DEFAULT 0, FCONTACTUNITTYPE NVARCHAR (30) NULL DEFAULT ' ', FCONTACTUNITID INT NOT NULL DEFAULT 0, FCONTACTUNITNUMBER NVARCHAR (80) NULL, FCONTACTUNITNAME NVARCHAR (255) NULL, FCURRENCYFORNAME NVARCHAR (30) NULL, FBUSINESSORGID INT NULL, FBUSINESSORGNAME NVARCHAR (255) NULL, FSETTLEORGNAME NVARCHAR (255) NULL, FRPORGID INT NULL, FRPORGNAME NVARCHAR (255) NULL, FBUSINESSDEPTID INT NULL, FBUSINESSDEPTNAME NVARCHAR (255) NULL, FBUSINESSGROUPID INT NULL, FBUSINESSGROUPNAME NVARCHAR (100) NULL, FBUSINESSERID INT NULL, FBUSINESSERNAME NVARCHAR (100) NULL, FBUSINESSDESP NVARCHAR (50) NULL, FBILLTYPEID NVARCHAR (40) NULL, FBILLTYPENAME NVARCHAR (60) NULL, FAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FHADIVAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FREALAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FOFFAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FLEFTAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FCURRENCYRECNAME NVARCHAR (30) NULL, FREFUNDAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FCURRENCYNAME NVARCHAR (30) NULL, FAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FHADIVAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FREALAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOFFAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FMATERIALID INT NULL, FMATERIALNUMBER NVARCHAR (80) NULL, FPAmountBegin DECIMAL (23, 10) NOT NULL DEFAULT 0, FPRECAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FPPAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FPLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOAmountBegin DECIMAL (23, 10) NOT NULL DEFAULT 0, FOInOutAmount DECIMAL (23, 10) NOT NULL DEFAULT 0, FOOutAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FQty DECIMAL (23, 10) NOT NULL DEFAULT 0, FUnitName NVARCHAR (80) NULL, FAMOUNTDIGITSFOR INT NULL DEFAULT 2, FAMOUNTDIGITS INT NULL DEFAULT 2, FNOTETYPE INT NOT NULL DEFAULT 1, FDetailType INT NOT NULL DEFAULT 3)



CREATE TABLE #TM_AR_DETAILRPT_DTL (FID INT NOT NULL DEFAULT 0, FFORMID NVARCHAR (80) NULL, FBILLNO NVARCHAR (80) NOT NULL DEFAULT ' ', FDATE DATETIME NULL, FBUSINESSRANK INT NULL DEFAULT 0, FCONTACTUNITID INT NULL, FCURRENCYFORID INT NULL, FBUSINESSORGID INT NULL, FSETTLEORGID INT NULL, FRPORGID INT NULL, FBUSINESSDEPTID INT NULL, FBUSINESSGROUPID INT NULL, FBUSINESSERID INT NULL, FBUSINESSTYPEID INT NULL, FSEQ INT NULL, FBILLTYPEID NVARCHAR (40) NULL, FAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FHADIVAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FREALAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FOFFAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FLEFTAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FSETTLECURRENCYID INT NULL, FREFUNDAMOUNTFOR DECIMAL (23, 10) NOT NULL DEFAULT 0, FCURRENCYID INT NULL, FAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FHADIVAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FREALAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOFFAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FAMOUNTDIGITSFOR INT NULL DEFAULT 2, FAMOUNTDIGITS INT NULL DEFAULT 2, FMATERIALID INT NULL, FMATERIALNUMBER NVARCHAR (80) NULL, FPAmountBegin DECIMAL (23, 10) NOT NULL DEFAULT 0, FPRECAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FPPAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FPLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOAmountBegin DECIMAL (23, 10) NOT NULL DEFAULT 0, FOInOutAmount DECIMAL (23, 10) NOT NULL DEFAULT 0, FOOutAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FOLEFTAMOUNT DECIMAL (23, 10) NOT NULL DEFAULT 0, FQty DECIMAL (23, 10) NOT NULL DEFAULT 0, FUnitName NVARCHAR (80) NULL)





exec sp_executesql N'INSERT INTO #TM_AR_ORGENDDATE (FSETTLEORGID, FENDDATE, FSYSSTARTDATE) SELECT org.FORGID, bal.FEndDate, prf.FsysStartdate FROM T_ORG_ORGANIZATIONS org LEFT OUTER JOIN (SELECT FSETTLEORGID, MAX(FENDDATE) fenddate FROM T_AR_CONTACTBAL bal WHERE (FTYPE = 0 AND (FENDDATE <= @FBeginDate)) GROUP BY FSETTLEORGID) bal ON org.FORGID = bal.FSETTLEORGID LEFT OUTER JOIN (SELECT FORGID, CONVERT(DATETIME, ISNULL(FVALUE, @initDate)) fsysstartdate FROM T_BAS_SYSTEMPROFILE WHERE (FCATEGORY = ''AR'' AND FKEY = ''ARStartDate'')) prf ON prf.FORGID = org.FORGID INNER JOIN @FORGID_udt1 SelOrg ON SelOrg.FID = org.FORGID',N'@FBeginDate datetime,@initDate datetime,@FORGID_udt1 [udt_inttable] READONLY',@FBeginDate='2016-11-16 00:00:00',@initDate='1900-01-01 00:00:00',@FORGID_udt1=@p5



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_receivable'' fformid, 1 fbusinessrank, T1.FCUSTOMERID fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FMAINBOOKSTDCURRID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 4 fbusinesstypeid, (0 + ISNULL(T1.FALLAMOUNTFOR, 0)) fleftamountfor, (0 + ISNULL(T2.FALLAMOUNT, 0)) fleftamount FROM t_AR_receivable T1 LEFT OUTER JOIN t_AR_receivableFIN T2 ON T1.FID = T2.FID LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCUSTOMERID = U31.FCUSTID WHERE ((((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND (T1.FALLAMOUNTFOR <> 0)) AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T1.FDate < @FBeginDATE)) AND 1 = 1) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FSETTLEORGID, FRPORGID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_OtherRecAble'' fformid, 2 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T1.FMAINBOOKSTDCURRID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FBILLTYPEID, 4 fbusinesstypeid, (0 + T1.FAMOUNTFOR) fleftamountfor, (0 + T1.FAMOUNT) fleftamount FROM T_AR_OtherRecAble T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T1.FDate < @FBeginDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FSETTLECURRENCYID, FREFUNDAMOUNTFOR, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_RECEIVEBILL'' fformid, 3 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FSETTLECUR fcurrencyforid, T1.FMAINBOOKCURID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 4 fbusinesstypeid, T1.FCURRENCYID, ISNULL(entry.FRECTOTALAMOUNTFOR, 0) frefundamountfor, (0 - ISNULL(entry.FRECTOTALAMOUNTFOR, 0)) fleftamountfor, (0 - ISNULL(entry.FRECTOTALAMOUNT, 0)) fleftamount FROM T_AR_RECEIVEBILL T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID INNER JOIN T_AR_RECEIVEBILLENTRY entry ON entry.FID = T1.FID INNER JOIN T_CN_RECPAYPURPOSE purpose ON (purpose.FID = entry.FPURPOSEID AND purpose.FFINMANEGEMENT = 1) WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T1.FDate < @FBeginDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FSETTLECURRENCYID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_REFUNDBILL'' fformid, 4 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FSETTLECUR fcurrencyforid, T1.FMAINBOOKCURRID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 4 fbusinesstypeid, T1.FCURRENCYID, (0 + ISNULL(entry.FREFUNDAMOUNTFOR, 0)) fleftamountfor, (0 + ISNULL(entry.FREFUNDAMOUNT, 0)) fleftamount FROM T_AR_REFUNDBILL T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID INNER JOIN T_AR_REFUNDBILLENTRY entry ON entry.FID = T1.FID INNER JOIN T_CN_RECPAYPURPOSE purpose ON (purpose.FID = entry.FPURPOSEID AND purpose.FFINMANEGEMENT = 1) WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T1.FDate < @FBeginDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FSEQ, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, T1.FSEQ, ''AP_Match'' fformid, 5 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''a7f7185a1c294df09755d9b0344f1cbd'' fbilltypeid, 4 fbusinesstypeid, CASE  WHEN (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_OtherRecAble'' OR B69.FBILLFORMID = ''AP_PAYBILL'') THEN (0 - T1.FMATCHAMOUNTFOR) ELSE (0 + T1.FMATCHAMOUNTFOR) END, CASE  WHEN (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_OtherRecAble'' OR B69.FBILLFORMID = ''AP_PAYBILL'') THEN (0 - T1.FMATCHAMOUNT) ELSE (0 + T1.FMATCHAMOUNT) END FROM T_AP_MatckEntry T1 LEFT OUTER JOIN T_AP_Matck T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T2.FDate < @FBeginDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FSEQ, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, T1.FSEQ, ''AR_Match'' fformid, 5 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''b9b2335770b84a3aa9b09b22767cd7e3'' fbilltypeid, 4 fbusinesstypeid, CASE  WHEN (B69.FBILLFORMID = ''AP_Payable'' OR B69.FBILLFORMID = ''AP_OtherPayable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'') THEN (0 + T1.FMATCHAMOUNTFOR) ELSE (0 - T1.FMATCHAMOUNTFOR) END, CASE  WHEN (B69.FBILLFORMID = ''AP_Payable'' OR B69.FBILLFORMID = ''AP_OtherPayable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'') THEN (0 + T1.FMATCHAMOUNT) ELSE (0 - T1.FMATCHAMOUNT) END FROM T_AR_MatckEntry T1 LEFT OUTER JOIN T_AR_Matck T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T2.FDate < @FBeginDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_InnerRecClear'' fformid, 6 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''c7a8e6ec73754c31b0cde0f8cc01e328'' fbilltypeid, 4 fbusinesstypeid, 0 - T1.FMATCHAMOUNTFOR, 0 - T1.FMATCHAMOUNT FROM T_AR_InnerRecClearEntry T1 LEFT OUTER JOIN T_AR_InnerRecClear T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= ISNULL(T501.FENDDATE, @initDate))) AND (T2.FDate < @FBeginDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FLEFTAMOUNTFOR, FLEFTAMOUNT) SELECT T1.FID, ''AR_CONTACTBAL'' fformid, 0 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T1.FSTANDCURRID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 4 fbusinesstypeid, (0 + T1.FBEGINBALANCEFOR) fleftamountfor, (0 + T1.FBEGINBALANCE) fleftamount FROM T_AR_CONTACTBAL T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((T1.FTYPE = 0 AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FENDDATE >= ISNULL(T501.FENDDATE, @initDate))) AND (T1.FENDDATE <= @FBeginDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0))',N'@FORGID_udt1 [udt_inttable] READONLY,@initDate datetime,@FBeginDATE datetime',@FORGID_udt1=@p3,@initDate='1900-01-01 00:00:00',@FBeginDATE='2016-11-16 00:00:00'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, 
FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FMaterialID, FMaterialNumber, FOLEFTAMOUNT, 
FUnitName, FQty, FBILLNO, FDATE, FAMOUNTFOR, FHADIVAMOUNTFOR, FAMOUNT, FHADIVAMOUNT) SELECT T1.FID, ''AR_receivable'' fformid, 1 fbusinessrank, T1.FCUSTOMERID fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FMAINBOOKSTDCURRID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 6 fbusinesstypeid, Entry.FMATERIALID, M2.FNumber, Entry.FTaxPrice, u3.FName, CASE  WHEN T1.FISINIT = ''1'' THEN Entry.FPRICEQTY ELSE Entry.FPRICEQTY END fqty, T1.FBILLNO fbillno, T1.FDATE fdate, (0 + ISNULL(Entry.FALLAMOUNTFOR, 0)) famountfor, 0 + ISNULL(FIVALLAMOUNTFOR, 0), (0 + ISNULL(Entry.FALLAMOUNT, 0)) famount, 0 + (ISNULL(FIVALLAMOUNTFOR, 0) * T2.FEXCHANGERATE) FROM t_AR_receivable T1 LEFT OUTER JOIN t_AR_receivableFIN T2 ON T1.FID = T2.FID LEFT OUTER JOIN t_AR_receivableENTRY Entry ON T1.FID = Entry.FID LEFT OUTER JOIN T_BD_MATERIAL M1 ON M1.FMaterialID = Entry.FMaterialID LEFT OUTER JOIN T_BD_MATERIAL M2 ON M2.FMaterialID = M1.FMasterID LEFT OUTER JOIN T_BD_UNIT u1 ON Entry.FPRICEUNITID = u1.FUNITID LEFT OUTER JOIN T_BD_UNIT u2 ON u1.FMASTERID = u2.FUNITID LEFT OUTER JOIN T_BD_UNIT_L u3 ON (u3.FUNITID = u2.FUNITID AND u3.FLocaleID = 2052) LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCUSTOMERID = U31.FCUSTID WHERE ((((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND (T1.FALLAMOUNTFOR <> 0)) AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= @FBeginDATE)) AND (T1.FDate <= @FEndDATE)) AND 1 = 1) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FSETTLEORGID, FRPORGID, FBILLTYPEID, FBUSINESSTYPEID, FBILLNO, FDATE, FAMOUNTFOR, FREALAMOUNTFOR, FAMOUNT, FREALAMOUNT) SELECT T1.FID, ''AR_OtherRecAble'' fformid, 2 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T1.FMAINBOOKSTDCURRID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FBILLTYPEID, 6 fbusinesstypeid, T1.FBILLNO fbillno, T1.FDATE fdate, (0 + T1.FAMOUNTFOR) famountfor, (0 + 0) frealamountfor, (0 + T1.FAMOUNT) famount, (0 + 0) frealamount FROM T_AR_OtherRecAble T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= @FBeginDATE)) AND (T1.FDate <= @FEndDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FSETTLECURRENCYID, FREFUNDAMOUNTFOR, FBILLNO, FDATE, FAMOUNTFOR, FREALAMOUNTFOR, FHADIVAMOUNTFOR, FAMOUNT, FREALAMOUNT, FHADIVAMOUNT) SELECT T1.FID, ''AR_RECEIVEBILL'' fformid, 3 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FSETTLECUR fcurrencyforid, T1.FMAINBOOKCURID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 7 fbusinesstypeid, T1.FCURRENCYID, ISNULL(entry.FRECTOTALAMOUNTFOR, 0) frefundamountfor, T1.FBILLNO fbillno, T1.FDATE fdate, 0 famountfor, (0 + ISNULL(entry.FRECTOTALAMOUNTFOR, 0)) frealamountfor, 0 fhadivamountfor, 0 famount, (0 + ISNULL(entry.FRECTOTALAMOUNT, 0)) frealamount, 0 fhadivamount FROM T_AR_RECEIVEBILL T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID INNER JOIN T_AR_RECEIVEBILLENTRY entry ON entry.FID = T1.FID INNER JOIN T_CN_RECPAYPURPOSE purpose ON (purpose.FID = entry.FPURPOSEID AND purpose.FFINMANEGEMENT = 1) WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= @FBeginDATE)) AND (T1.FDate <= @FEndDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'




exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FSETTLECURRENCYID, FBILLNO, FDATE, FAMOUNTFOR, FREALAMOUNTFOR, FHADIVAMOUNTFOR, FAMOUNT, FREALAMOUNT, FHADIVAMOUNT, FREFUNDAMOUNTFOR) SELECT T1.FID, ''AR_REFUNDBILL'' fformid, 4 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FSETTLECUR fcurrencyforid, T1.FMAINBOOKCURRID, T1.FSALEORGID, T1.FSETTLEORGID, T1.FPAYORGID frporgid, T1.FSALEDEPTID, T1.FSALEGROUPID, T1.FSALEERID, T1.FBILLTYPEID, 7 fbusinesstypeid, T1.FCURRENCYID, T1.FBILLNO fbillno, T1.FDATE fdate, 0 famountfor, (0 - ISNULL(entry.FREFUNDAMOUNTFOR, 0)) frealamountfor, 0 fhadivamountfor, 0 famount, (0 - ISNULL(entry.FREFUNDAMOUNT, 0)) frealamount, 0 fhadivamount, (0 - ISNULL(entry.FREALREFUNDAMOUNTFOR, 0)) frefundamountfor FROM T_AR_REFUNDBILL T1 LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T1.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID INNER JOIN T_AR_REFUNDBILLENTRY entry ON entry.FID = T1.FID INNER JOIN T_CN_RECPAYPURPOSE purpose ON (purpose.FID = entry.FPURPOSEID AND purpose.FFINMANEGEMENT = 1) WHERE (((((((((T1.FDOCUMENTSTATUS <> ''Z'') AND T1.FCANCELSTATUS = ''A'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T1.FSETTLEORGID)) AND (T1.FISINIT = ''1'' OR (T1.FDate >= T501.FSYSSTARTDATE))) AND (T1.FDate >= @FBeginDATE)) AND (T1.FDate <= @FEndDATE)) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T1.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FSEQ, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FBILLNO, FDATE, FOFFAMOUNTFOR, FOFFAMOUNT) SELECT T1.FID, T1.FSEQ, ''AP_Match'' fformid, 5 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''a7f7185a1c294df09755d9b0344f1cbd'' fbilltypeid, 3 fbusinesstypeid, T2.FBILLNO fbillno, T2.FDATE fdate, CASE  WHEN (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_OtherRecAble'' OR B69.FBILLFORMID = ''AP_PAYBILL'') THEN (0 + T1.FMATCHAMOUNTFOR) ELSE (0 - T1.FMATCHAMOUNTFOR) END, CASE  WHEN (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_OtherRecAble'' OR B69.FBILLFORMID = ''AP_PAYBILL'') THEN (0 + T1.FMATCHAMOUNT) ELSE (0 - T1.FMATCHAMOUNT) END FROM T_AP_MatckEntry T1 LEFT OUTER JOIN T_AP_Matck T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= @FBeginDATE)) AND (T2.FDate <= @FEndDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'


exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FSEQ, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FBILLNO, FDATE, FOFFAMOUNTFOR, FOFFAMOUNT) SELECT T1.FID, T1.FSEQ, ''AR_Match'' fformid, 5 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''b9b2335770b84a3aa9b09b22767cd7e3'' fbilltypeid, 3 fbusinesstypeid, T2.FBILLNO fbillno, T2.FDATE fdate, CASE  WHEN (B69.FBILLFORMID = ''AP_Payable'' OR B69.FBILLFORMID = ''AP_OtherPayable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'') THEN (0 - T1.FMATCHAMOUNTFOR) ELSE (0 + T1.FMATCHAMOUNTFOR) END, CASE  WHEN (B69.FBILLFORMID = ''AP_Payable'' OR B69.FBILLFORMID = ''AP_OtherPayable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'') THEN (0 - T1.FMATCHAMOUNT) ELSE (0 + T1.FMATCHAMOUNT) END FROM T_AR_MatckEntry T1 LEFT OUTER JOIN T_AR_Matck T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= @FBeginDATE)) AND (T2.FDate <= @FEndDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'



exec sp_executesql N'INSERT INTO #TM_AR_DETAILRPT_DTL (FID, FFORMID, FBUSINESSRANK, FCONTACTUNITID, FCURRENCYFORID, FCURRENCYID, FBUSINESSORGID, FSETTLEORGID, FRPORGID, FBUSINESSDEPTID, FBUSINESSGROUPID, FBUSINESSERID, FBILLTYPEID, FBUSINESSTYPEID, FBILLNO, FDATE, FOFFAMOUNTFOR, FOFFAMOUNT) SELECT T1.FID, ''AR_InnerRecClear'' fformid, 6 fbusinessrank, T1.FCONTACTUNIT fcontactunitid, T1.FCURRENCYID fcurrencyforid, T2.FLOCALCURRID, T1.FBUSINESSORGID, T2.FSETTLEORGID, T2.FPAYORGID frporgid, T1.FBUSINESSDEPTID, T1.FBUSINESSGROUPID, T1.FBUSINESSERID, ''c7a8e6ec73754c31b0cde0f8cc01e328'' fbilltypeid, 3 fbusinesstypeid, T2.FBILLNO fbillno, T2.FDATE fdate, 0 + T1.FMATCHAMOUNTFOR, 0 + T1.FMATCHAMOUNT FROM T_AR_InnerRecClearEntry T1 LEFT OUTER JOIN T_AR_InnerRecClear T2 ON T1.FID = T2.FID LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FSOURCETYPE LEFT OUTER JOIN #TM_AR_ORGENDDATE T501 ON T501.FSETTLEORGID = T2.FSETTLEORGID INNER JOIN T_BD_CUSTOMER U31 ON T1.FCONTACTUNIT = U31.FCUSTID WHERE (((((((((T2.FDOCUMENTSTATUS <> ''Z'') AND EXISTS (SELECT 1 FROM @FORGID_udt1 SelOrg WHERE SelOrg.FID = T2.FSETTLEORGID)) AND (T2.FDate >= @FBeginDATE)) AND (T2.FDate <= @FEndDATE)) AND (T1.FMATCHTYPE <> ''3'')) AND (B69.FBILLFORMID = ''AR_receivable'' OR B69.FBILLFORMID = ''AR_RECEIVEBILL'' OR B69.FBILLFORMID = ''AR_REFUNDBILL'' OR B69.FBILLFORMID = ''AR_OtherRecAble'')) AND (1 = 1 AND T1.FCONTACTUNITTYPE = ''BD_Customer'')) AND (1 = 1 AND U31.FCorrespondOrgId = 0)) AND T2.FDOCUMENTSTATUS = ''C'')',N'@FORGID_udt1 [udt_inttable] READONLY,@FBeginDATE datetime,@FEndDATE datetime',@FORGID_udt1=@p3,@FBeginDATE='2016-11-16 00:00:00',@FEndDATE='2016-11-16 23:59:59'




INSERT INTO #TM_AR_DETAILRPT_SUM (FCONTACTUNITTYPE, FCONTACTUNITID, FCONTACTUNITNUMBER, FCONTACTUNITNAME, FCURRENCYFORNAME, FBUSINESSORGID, 
FBUSINESSORGNAME, FSETTLEORGNAME, FRPORGID, FRPORGNAME, FBUSINESSDESP, FCURRENCYNAME, FLEFTAMOUNTFOR, FLEFTAMOUNT, FAMOUNTDIGITSFOR, FAMOUNTDIGITS, 
FDetailType) SELECT max(ISNULL(B21.FFormID, ' ')), max(ISNULL(B21.FMASTERID, 0)), max(ISNULL(B21.FNumber, ' ')) fcontactunitnumber, max(ISNULL(B2.FNAME, ' 
')) fcontactunitname, max(ISNULL(T73.FNAME, ' ')) fcurrencyforname, max(ISNULL(T1.FBUSINESSORGID, 0)), max(ISNULL(B4.FNAME, ' ')) fbusinessorgname, 
max(ISNULL(B3.FNAME, ' ')) fsettleorgname, max(ISNULL(T1.FRPORGID, 0)), max(ISNULL(B33.FNAME, ' ')) frporgname, max(ISNULL(C1.FNAME, ' ')) fbusinessdesp, 
max(ISNULL(T72.FNAME, ' ')) fcurrencyname, sum(CASE T1.FBUSINESSTYPEID WHEN 4 THEN T1.FLEFTAMOUNTFOR ELSE 0 END), sum(CASE T1.FBUSINESSTYPEID WHEN 4 THEN T1.FLEFTAMOUNT ELSE 0 END), max(T70.FAMOUNTDIGITS) famountdigitsfor, max(ISNULL(T71.FAMOUNTDIGITS, 2)) famountdigits, 1 fdetailtype FROM #TM_AR_DETAILRPT_DTL T1 LEFT OUTER JOIN V_FIN_CONTACTTYPE B21 ON T1.FCONTACTUNITID = B21.FITEMID LEFT OUTER JOIN V_FIN_CONTACTTYPE_L B2 ON (B21.FITEMID = B2.FITEMID AND B2.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY T70 ON T70.FCURRENCYID = T1.FCURRENCYFORID LEFT OUTER JOIN T_BD_CURRENCY T71 ON T71.FCURRENCYID = T1.FCURRENCYID LEFT OUTER JOIN T_BD_CURRENCY T74 ON T74.FCURRENCYID = T1.FSETTLECURRENCYID LEFT OUTER JOIN T_BD_CURRENCY_L T72 ON (T72.FCURRENCYID = T71.FCURRENCYID AND T72.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY_L T73 ON (T73.FCURRENCYID = T70.FCURRENCYID AND T73.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY_L T75 ON (T75.FCURRENCYID = T74.FCURRENCYID AND T75.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B4 ON (B4.FORGID = T1.FBUSINESSORGID AND B4.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B3 ON (B3.FORGID = T1.FSETTLEORGID AND B3.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B33 ON (B33.FORGID = T1.FRPORGID AND B33.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_DEPARTMENT_L B5 ON (B5.FDEPTID = T1.FBUSINESSDEPTID AND B5.FLOCALEID = 2052) LEFT OUTER JOIN V_BD_OPERATORGROUP_L B7 ON (B7.FENTRYID = T1.FBUSINESSGROUPID AND B7.FLOCALEID = 2052) LEFT OUTER JOIN V_BD_SALESMAN_L B8 ON (B8.FID = T1.FBUSINESSERID AND B8.FLOCALEID = 2052) LEFT OUTER JOIN T_AR_BusinessTYPEENUM_L C1 ON (C1.FID = 4 AND C1.FLOCALEID = 2052) LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FBILLTYPEID LEFT OUTER JOIN T_BAS_BillType_L T69 ON (T69.FBILLTYPEID = B69.FBILLTYPEID AND T69.FLOCALEID = 2052) WHERE 1 = 1 GROUP BY B21.FFormID, B21.FNumber, T73.FNAME, B2.FNAME



INSERT INTO #TM_AR_DETAILRPT_SUM (FID, FFORMID, FBILLNO, FDATE, FBUSINESSRANK, FCONTACTUNITTYPE, FCONTACTUNITID, FCONTACTUNITNUMBER, FCONTACTUNITNAME, 
FCURRENCYFORNAME, FBUSINESSORGID, FBUSINESSORGNAME, FSETTLEORGNAME, FRPORGID, FRPORGNAME, FBUSINESSDEPTID, FBUSINESSDEPTNAME, FBUSINESSGROUPID, 
FBUSINESSGROUPNAME, FBUSINESSERID, FBUSINESSERNAME, FBUSINESSDESP, FBILLTYPEID, FBILLTYPENAME, FCURRENCYNAME, FCURRENCYRECNAME, FREFUNDAMOUNTFOR, FAMOUNT, 
FHADIVAMOUNT, FREALAMOUNT, FOFFAMOUNT, FAMOUNTFOR, FHADIVAMOUNTFOR, FREALAMOUNTFOR, FOFFAMOUNTFOR, FAMOUNTDIGITSFOR, FAMOUNTDIGITS, FDetailType) SELECT 
T1.FID, T1.FFORMID, T1.FBILLNO, max(T1.FDATE), T1.FBUSINESSRANK, max(ISNULL(B21.FFormID, ' ')), max(ISNULL(B21.FMASTERID, 0)), max(ISNULL(B21.FNumber, ' ')) 
fcontactunitnumber, max(ISNULL(B2.FNAME, ' ')) fcontactunitname, max(ISNULL(T73.FNAME, ' ')) fcurrencyforname, max(ISNULL(T1.FBUSINESSORGID, 0)), 
max(ISNULL(B4.FNAME, ' ')) fbusinessorgname, max(ISNULL(B3.FNAME, ' ')) fsettleorgname, max(ISNULL(T1.FRPORGID, 0)), max(ISNULL(B33.FNAME, ' ')) frporgname, 
max(ISNULL(T1.FBUSINESSDEPTID, 0)), max(ISNULL(B5.FNAME, ' ')) fbusinessdeptname, max(ISNULL(T1.FBUSINESSGROUPID, 0)), max(ISNULL(B7.FNAME, ' ')) 
fbusinessgroupname, max(ISNULL(T1.FBUSINESSERID, 0)), max(ISNULL(B8.FNAME, ' ')) fbusinessername, max(ISNULL(C1.FNAME, ' ')) fbusinessdesp, 
max(ISNULL(T1.FBILLTYPEID, ' ')) fbilltypeid, max(ISNULL(T69.FNAME, ' ')) fbilltypename, max(ISNULL(T72.FNAME, ' ')) fcurrencyname, max(ISNULL(T75.FNAME, ' 
')) fcurrencyrecname, sum(T1.FREFUNDAMOUNTFOR), sum(T1.FAMOUNT), sum(T1.FHADIVAMOUNT), sum(T1.FREALAMOUNT), sum(T1.FOFFAMOUNT), sum(T1.FAMOUNTFOR), 
sum(T1.FHADIVAMOUNTFOR), sum(T1.FREALAMOUNTFOR), sum(T1.FOFFAMOUNTFOR), max(T70.FAMOUNTDIGITS) famountdigitsfor, max(ISNULL(T71.FAMOUNTDIGITS, 2)) famountdigits, 2 fdetailtype FROM #TM_AR_DETAILRPT_DTL T1 LEFT OUTER JOIN V_FIN_CONTACTTYPE B21 ON T1.FCONTACTUNITID = B21.FITEMID LEFT OUTER JOIN V_FIN_CONTACTTYPE_L B2 ON (B21.FITEMID = B2.FITEMID AND B2.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY T70 ON T70.FCURRENCYID = T1.FCURRENCYFORID LEFT OUTER JOIN T_BD_CURRENCY T71 ON T71.FCURRENCYID = T1.FCURRENCYID LEFT OUTER JOIN T_BD_CURRENCY T74 ON T74.FCURRENCYID = T1.FSETTLECURRENCYID LEFT OUTER JOIN T_BD_CURRENCY_L T72 ON (T72.FCURRENCYID = T71.FCURRENCYID AND T72.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY_L T73 ON (T73.FCURRENCYID = T70.FCURRENCYID AND T73.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_CURRENCY_L T75 ON (T75.FCURRENCYID = T74.FCURRENCYID AND T75.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B4 ON (B4.FORGID = T1.FBUSINESSORGID AND B4.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B3 ON (B3.FORGID = T1.FSETTLEORGID AND B3.FLOCALEID = 2052) LEFT OUTER JOIN T_ORG_ORGANIZATIONS_L B33 ON (B33.FORGID = T1.FRPORGID AND B33.FLOCALEID = 2052) LEFT OUTER JOIN T_BD_DEPARTMENT_L B5 ON (B5.FDEPTID = T1.FBUSINESSDEPTID AND B5.FLOCALEID = 2052) LEFT OUTER JOIN V_BD_OPERATORGROUP_L B7 ON (B7.FENTRYID = T1.FBUSINESSGROUPID AND B7.FLOCALEID = 2052) LEFT OUTER JOIN V_BD_SALESMAN_L B8 ON (B8.FID = T1.FBUSINESSERID AND B8.FLOCALEID = 2052) LEFT OUTER JOIN T_AR_BusinessTYPEENUM_L C1 ON (C1.FID = T1.FBUSINESSTYPEID AND C1.FLOCALEID = 2052) LEFT OUTER JOIN T_BAS_BillType B69 ON B69.FBILLTYPEID = T1.FBILLTYPEID LEFT OUTER JOIN T_BAS_BillType_L T69 ON (T69.FBILLTYPEID = B69.FBILLTYPEID AND T69.FLOCALEID = 2052) WHERE (1 = 1 AND (T1.FBUSINESSTYPEID <> 4)) GROUP BY B21.FNumber, T73.FNAME, B2.FNAME, T1.FID, T1.FFORMID, T1.FBILLNO, T1.FBUSINESSRANK, B21.FFormID, T1.FSEQ


exec sp_executesql N'INSERT INTO T_BAS_TEMPORARYTABLENAME (FTABLENAME, FUSERTOKEN, FUSERTRANSACTIONID) VALUES (@FTABLENAME, @FUSERTOKEN, @FUSERTRANSACTIONID)',N'@FTABLENAME varchar(30),@FUSERTOKEN varchar(36),@FUSERTRANSACTIONID varchar(1)',@FTABLENAME='TMP8CEE7BD4ABD311E68117EC8F87C',@FUSERTOKEN='1e0540e2-b5d9-4b7f-9b87-4710d0dcc36d',@FUSERTRANSACTIONID=' '



SELECT A.* INTO TMP8CEE7BD5ABD311E68117EC8F87C FROM (SELECT DISTINCT A.fcontactunitnumber, A.fcurrencyname, A.fsettleorgname, A.fcurrencyrecname, A.fnotetype, A.fdetailtablename, FIDENTITYID fidentityid2, A.FINITAMOUNTFOR, A.FAMOUNTFOR, A.FHadIVAmountFOR, A.FREALAMOUNTFOR, A.FOFFAMOUNTFOR, A.FLEFTAMOUNTFOR, A.FINITAMOUNT, A.FAMOUNT, A.FHADIVAMOUNT, A.FREALAMOUNT, A.FOFFAMOUNT, A.FLEFTAMOUNT, A.FAMOUNTDIGITSFOR, A.FAMOUNTDIGITS, A.FREFUNDAMOUNTFOR, A.FCONTACTUNITNAME, A.FCURRENCYFORNAME, 0 fgrouplevel, -1 fgrouping FROM TMP8CEE7BC9ABD311E68117EC8F87C A UNION ALL SELECT NULL fcontactunitnumber, NULL fcurrencyname, NULL fsettleorgname, NULL fcurrencyrecname, NULL fnotetype, NULL fdetailtablename, NULL fidentityid2, A.FINITAMOUNTFOR, A.FAMOUNTFOR, A.FHadIVAmountFOR, A.FREALAMOUNTFOR, A.FOFFAMOUNTFOR, A.FLEFTAMOUNTFOR, A.FINITAMOUNT, A.FAMOUNT, A.FHADIVAMOUNT, A.FREALAMOUNT, A.FOFFAMOUNT, A.FLEFTAMOUNT, A.FAMOUNTDIGITSFOR, A.FAMOUNTDIGITS, A.FREFUNDAMOUNTFOR, A.FCONTACTUNITNAME, A.FCURRENCYFORNAME, FGROUPLEVEL, FGROUPING FROM (SELECT FCONTACTUNITNAME, FCURRENCYFORNAME, ROW_NUMBER() OVER(PARTITION BY FCONTACTUNITNAME ORDER BY FCONTACTUNITNAME ASC) fgrouplevel, GROUPING(FCURRENCYFORNAME) fgrouping, SUM(FINITAMOUNTFOR) finitamountfor, SUM(FAMOUNTFOR) famountfor, SUM(FHadIVAmountFOR) fhadivamountfor, SUM(FREALAMOUNTFOR) frealamountfor, SUM(FOFFAMOUNTFOR) foffamountfor, SUM(FLEFTAMOUNTFOR) fleftamountfor, SUM(FINITAMOUNT) finitamount, SUM(FAMOUNT) famount, SUM(FHADIVAMOUNT) fhadivamount, SUM(FREALAMOUNT) frealamount, SUM(FOFFAMOUNT) foffamount, SUM(FLEFTAMOUNT) fleftamount, MAX(FAMOUNTDIGITSFOR) famountdigitsfor, MAX(FAMOUNTDIGITS) famountdigits, SUM(FREFUNDAMOUNTFOR) frefundamountfor FROM TMP8CEE7BC9ABD311E68117EC8F87C F GROUP BY FCONTACTUNITNAME, FCURRENCYFORNAME WITH ROLLUP) a) a ORDER BY A.FIDENTITYID2 ASC



exec sp_executesql N'INSERT INTO T_BAS_TEMPORARYTABLENAME (FTABLENAME, FUSERTOKEN, FUSERTRANSACTIONID) VALUES (@FTABLENAME, @FUSERTOKEN, @FUSERTRANSACTIONID)',N'@FTABLENAME varchar(30),@FUSERTOKEN varchar(36),@FUSERTRANSACTIONID varchar(1)',@FTABLENAME='TMP8CEE7BD6ABD311E68117EC8F87C',@FUSERTOKEN='1e0540e2-b5d9-4b7f-9b87-4710d0dcc36d',@FUSERTRANSACTIONID=' '


